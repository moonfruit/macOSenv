#!/usr/bin/env bash

if echo "$1" | grep -Exq '[0-9]+|https?:.*|gingkoo'; then
	if [[ $1 == gingkoo ]]; then
		port=http://10.1.2.12:8118
	else
		port="$1"
	fi
	shift

else
	#port=http://10.1.2.12:8118
	#port=7890
	port=11001
fi

if [[ $port == 0 ]]; then
	exec "$@"
fi

export PROXY_ENABLED=1

if [[ $port == 1080 ]]; then
	exec proxychains "$port" "$@"

elif [[ $port =~ https?:.* ]]; then
	export http_proxy="$port"
	export https_proxy="$http_proxy"

elif [[ $port == 9999 ]]; then
	auth=$(crypto.py decrypt BuwwEbpxczjslVL4Y3AruywdBSQeX8MD4dZ5sYfdECztDAYpulxRFcyQdTJ8)
	export http_proxy="http://$auth@127.0.0.1:$port"
	export https_proxy="$http_proxy"

else
	export http_proxy="http://127.0.0.1:$port"
	export https_proxy="$http_proxy"

	if [[ $1 == "gu" ]]; then
		extra=(
			--vm.Dhttp.proxyHost=127.0.0.1
			--vm.Dhttp.proxyPort="$port"
			--vm.Dhttps.proxyHost=127.0.0.1
			--vm.Dhttps.proxyPort="$port"
			--vm.Dhttp.nonProxyHosts="localhost|*.gingkoo|127.*|192.168.*|10.*"
		)
		shift
		exec gu "${extra[@]}" "$@"
	fi
fi

if [[ -z $no_proxy ]]; then
	# shellcheck source=../etc/no_proxy.sh
	source "$ENV/etc/no_proxy.sh"
fi

exec "$@"
