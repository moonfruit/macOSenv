#!/usr/bin/env bash

if [[ "$1" =~ ^(:?[0-9]+|https?:.*|gingkoo|none)$ ]]; then
	case $1 in
	gingkoo) port=http://10.1.2.12:8118 ;;
	none) port=0 ;;
	:*) port=${1:1} ;;
	*) port=$1 ;;
	esac
	shift
else
	#port=http://10.1.2.12:8118
	#port=7890
	port=10001
fi

export PROXY_ENABLED=1

if [[ $port == 0 ]]; then
	exec "$@"

elif [[ $port == 1080 ]]; then
	exec proxychains "$port" "$@"

elif [[ $port =~ https?:.* ]]; then
	export http_proxy="$port"
	export https_proxy="$http_proxy"

elif [[ $port == 9999 ]]; then
	auth=$(crypto.py decrypt BuwwEbpxczjslVL4Y3AruywdBSQeX8MD4dZ5sYfdECztDAYpulxRFcyQdTJ8)
	export http_proxy="http://$auth@127.0.0.1:$port"
	export https_proxy="$http_proxy"

else
	export http_proxy="http://127.0.0.1:$port"
	export https_proxy="$http_proxy"

	if [[ $1 == "gu" ]]; then
		extra=(
			--vm.Dhttp.proxyHost=127.0.0.1
			--vm.Dhttp.proxyPort="$port"
			--vm.Dhttps.proxyHost=127.0.0.1
			--vm.Dhttps.proxyPort="$port"
			--vm.Dhttp.nonProxyHosts="localhost|*.gingkoo|127.*|192.168.*|10.*"
		)
		shift
		exec gu "${extra[@]}" "$@"
	fi
fi

if [[ -z $no_proxy ]]; then
	# shellcheck source=../etc/no_proxy.sh
	source "$ENV/etc/no_proxy.sh"
fi

exec "$@"
