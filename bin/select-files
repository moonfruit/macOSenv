#!/bin/bash

usage() {
    echo "Usage: $0 [-d] [-m] type..." 1>&2
    exit 1
}

ITEM="File"
PARAMS=()
CONVERTER="toString()"
OSASCRIPT=("osascript" "-l" "JavaScript")
while getopts "dmx" OPT; do
    case "$OPT" in
    d) ITEM=Folder ;;
    m)
        PARAMS+=("multipleSelectionsAllowed:true")
        CONVERTER="join('\n')"
        ;;
    x) OSASCRIPT=("cat") ;;
    *) usage ;;
    esac
done
shift $((OPTIND - 1))

join() {
    local IFS=","
    echo "$*"
}

join_quoted() {
    local result=()
    for arg in "$@"; do
        result+=("'$arg'")
    done
    join "${result[@]}"
}

if (($#)); then
    if [[ $ITEM = File ]]; then
        PARAMS+=("ofType:[$(join_quoted "$@")]")
    else
        usage
    fi
fi

if ((${#PARAMS[@]})); then
    PARAM="{$(join "${PARAMS[@]}")}"
fi

"${OSASCRIPT[@]}" <<END
const app = Application.currentApplication();
app.includeStandardAdditions = true;
app.choose$ITEM($PARAM).$CONVERTER;
END
